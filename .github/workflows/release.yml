name: Publish to npm

on:
  push:
    tags:
      - '*' # we filter in if because ** doesn't work well

  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to run the workflow with'
        required: true
        type: string

permissions:
  contents: write # for the GitHub Changelog
  id-token: write # required for npm trusted publishing

jobs:
  release:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref_name, 'v') ||
      contains(github.ref_name, '@') &&
      (
        github.ref_name =~ '.+@[0-9]+\.[0-9]+\.[0-9]+$'
      )

    steps:
      - name: Setup JS
        uses: sxzz/workflows/setup-js@v1
        with:
          fetch-all: false

      - name: Get tag
        id: vars
        run: |
          TAG="${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}"
          echo "Using tag: $TAG"
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      # Determine path and package name from the tag
      - name: Resolve package folder
        id: resolve
        run: |
          TAG="${{ steps.vars.outputs.TAG }}"

          # ---------------------------
          # MAIN PACKAGE (vX.Y.Z)
          # ---------------------------
          if [[ "$TAG" =~ ^v[0-9] ]]; then
            echo "PACKAGE_PATH=." >> $GITHUB_OUTPUT
            exit 0
          fi

          # --------------------------------
          # SCOPED PACKAGES e.g. @posva/name@1.2.3
          # --------------------------------
          PKG_NAME=$(echo "$TAG" | sed -E 's/(.+)@.+/\1/')

          # Define your custom mapping table in bash
          declare -A MAP=(
            ["@posva/mono-repo-test-plugin-a"]="plugins/test-a"
            ["@posva/mono-repo-test-package"]="test-package"
          )

          if [[ -z "${MAP[$PKG_NAME]}" ]]; then
            echo "❌ Unknown package name '$PKG_NAME' — add it to the MAP" >&2
            exit 1
          fi

          echo "PACKAGE_PATH=${MAP[$PKG_NAME]}" >> $GITHUB_OUTPUT

      - name: Generate GitHub Changelog
        run: pnpx changelogithub
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        run: pnpm build
        working-directory: ${{ steps.resolve.outputs.PACKAGE_PATH }}

      - name: Publish to NPM
        run: pnpm publish
        working-directory: ${{ steps.resolve.outputs.PACKAGE_PATH }}
